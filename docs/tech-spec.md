# Техническое задание (ТЗ)

## Проект
Административная панель платформы доставки еды.

## Цель документа
ТЗ описывает требования к доработке админ-панели до production-уровня (уровень Yandex Go / Wolt / Uzum) с полным контролем заказов, партнёров, точек, курьеров, промокодов и финансов.

## 1. Профиль пользователя

### 1.1 Вкладка «Заказы»

#### Требования
- Каждая строка заказа кликабельна.
- При клике открывается детальная страница заказа.

#### Детали заказа
- Состав заказа: наименование блюда, количество, цена за единицу, итог по позиции.
- Комментарии клиента: к ресторану, к адресу.
- Адрес доставки (с деталями).
- Финансы: стоимость блюд, доставка, сервисный сбор, скидка/промокод, итоговая сумма.
- Данные получателя: имя, номер получателя, номер заказчика.
- Количество персон/приборов.

#### Действия
- «Выдать компенсацию»: выбор причины, сумма или процент, комментарий.

## 2. Профиль партнёра

### 2.1 Контактные данные
Обязательные поля:
- Телефон 1
- Телефон 2
- Телефон 3
- Email
- ФИО руководителя / ответственного лица

### 2.2 Финансовый раздел
Добавить вкладку «Финансы»:
- общий оборот по всем точкам партнёра
- комиссии платформы
- выплаты партнёру
- история транзакций

## 2.5 Профиль клиента (CRM v2)

### Требования
- Read-only карточка данных клиента.
- CRM комментарий (single note).
- Подписки: email/push/sms + продуктовые флаги.
- Danger zone: удалить email / сбросить passport UID / бан/разбан.
- Аккордеон: Orders, Addresses, Promos, Compensations, Messages, Audit, Notes.

### Backend
- `GET /api/clients/:id` возвращает `crm_note` и `subscriptions`.
- `PATCH /api/clients/:id/crm-note` — сохранить CRM note.
- `PATCH /api/clients/:id/subscriptions` — сохранить подписки.
- `POST /api/clients/:id/actions` — лог опасных действий (reason required).
- `GET /api/clients/:id/compensations` — ledger операции клиента.
- `GET /api/clients/:id/messages` — список сообщений (stub).
- `GET /api/clients/:id/audit` — audit log.

### Логирование
- Все действия пишутся в audit log и `client_sensitive_actions`.
## 3. Профиль точки (ресторана / магазина)

### 3.1 Вкладка «Обзор»
Отображать:
- Контактные данные (телефон, email)
- Адрес + комментарий к адресу
- Время работы
- Зона доставки
- Текущий статус точки

### 3.2 Управление статусом точки
Кнопки:
- «Временно отключить» (обязательный выбор причины)
- «Активировать»
- «Заблокировать»

## 4. Профиль точки → Меню / Товары

### 4.1 Управление позициями
Функции:
- Добавить позицию
- Изменить позицию
- Удалить позицию
- Стоп-лист: временная недоступность, причина, автоматическое восстановление (опционально)

### 4.2 Данные позиции
- Название
- Описание
- Фото
- Вес
- Цена
- SKU
- Категория: выбор из справочника точки или создание новой (с нормализацией, без дублей).

### 4.3 Профиль блюда (Item Profile)
- Read-only блок: ID позиции, ID точки, created_at/updated_at.
- Контент: название, короткое название, описание, категории, SKU, приоритет.
- Медиа: image_url + toggle image_enabled.
- Флаги: is_visible, is_adult.
- Доставка: delivery_methods (courier/pickup).
- Склад: base_price, stock_qty, текущая доступность.
- Стоплист: active, until, reason + авто-снятие при истечении срока.
- Питательность: kcal/protein/fat/carbs.
- Действия: Save, Duplicate, Copy-to-outlet, Back.
- Все изменения логируются в audit log.

## 5. Профиль точки → Кампании и сеты

### 5.1 Сущность кампании
- Типы: discount, bundle, bogo.
- Статусы: draft, active, paused, expired, archived (expired, если end_at прошло).
- Расписание: start_at/end_at, active_days, active_hours.
- Лимиты: min_order_amount, max_uses_total, max_uses_per_client.
- Delivery methods: courier/pickup.
- Stoplist policy: hide/disable.

### 5.2 Состав кампании
- Список позиций (items) с qty и required.
- Для discount: discount_type и discount_value по позиции.
- Для bundle: цена сета (fixed) или процент (percent).

### 5.3 Валидации
- start_at <= end_at.
- items не пустые.
- bundle: либо fixed_price, либо percent_discount.
- bundle выгоднее суммы позиций: warning, если равно; error, если выше суммы.
- лимиты >= 0.

### 5.4 Admin UI и интеграции
- Вкладка Campaigns в профиле точки: таблица + фильтры + create.
- Campaign Profile: секции basic/schedule/limits/items/bundle + actions Save/Activate/Pause/Archive/Duplicate.
- Валидационные предупреждения отображаются через `/api/campaigns/:id/validate`.
- Таблица заказов по кампании (campaign_usage).
- Все действия пишутся в audit log.

## 6. Order pricing и ledger

### 6.1 Расчет заказа
- Единый расчет на backend (computeOrderPricing).
- Базовый subtotal из order_items.
- Promo discount и campaign/bundle discount рассчитываются отдельно.
- Итог: subtotal + fees - promo_discount - campaign_discount.
- Сохраняются: promo_discount_amount, campaign_discount_amount, total_amount.

### 6.2 Ledger и корректировки
- Все денежные эффекты проходят через finance_ledger.
- Для ручных/авто корректировок создаются записи order_adjustments.
- Компенсации и возвраты пишутся в ledger и audit log.

## 7. Профиль курьера

### Обязательные данные
- ФИО
- Телефон
- Адрес проживания
- Способы доставки: пешком, велосипед, автомобиль/мотоцикл
- Рейтинг

### Функции
- Редактирование всех данных
- Управление статусом курьера

## 7. Профиль заказа — Обзор

### 7.1 Основная информация
- Время создания заказа
- Фактическое время доставки
- Обещанное время доставки (до HH:MM)
- Статус отправки заказа в ресторан

### 7.2 Связанные сущности
- Переход в профиль ресторана
- Переход в профиль курьера

### 7.3 Действия поддержки
Разместить в обзоре:
- Переназначить курьера
- Отменить заказ (с выбором причины)
- Отправить уведомление клиенту
- Переотправить заказ в ресторан
- Выдать компенсацию

#### 7.3.1 Отмена заказа (production)
- Причины отмены сгруппированы по группам: Client / Partner / Courier.
- Справочник причин хранится в `cancel_reasons` и поддерживает локализацию.
- Для отдельных причин комментарий обязателен.
- Авто-эффекты отображаются read-only (refund/compensation/penalty/promo).
- Все эффекты применяются на backend через ledger и логируются в audit.
- Создается запись в `order_cancellations` + событие `order_events` (type=cancelled).
- Статус заказа меняется на `cancelled` и фиксируется `cancelled_at`.

### 7.4 Дополнительные данные
- Заказ другому человеку (да/нет)
- Имя получателя
- Номер получателя
- Номер заказчика
- Комментарии клиента
- CRM-комментарий (внутренний)

### 7.5 Корзина заказа
- Список блюд, количество, вес, цена, итог.
- Возможность добавлять, изменять, удалять позиции.
- Для каждой позиции: иконка информации + модальное окно с фото и описанием.

### 7.6 Оплата
- Стоимость корзины
- Сервисный сбор
- Стоимость доставки
- Акция/промокод
- Сумма скидки
- Итоговая сумма
- Сумма заказа для ресторана

### 7.7 Сохранение изменений
- Кнопка «Сохранить заказ»
- Обязательный комментарий при изменениях

## 8. Профиль заказа — Таймлайн

### Отображать
- Обещали доставить до
- Минуты на готовку
- Минуты на доставку
- Опоздание (если есть)

### Этапы
1. Заказ принят
2. Готов к доставке
3. Курьер прибыл в ресторан
4. Курьер забрал заказ
5. Курьер прибыл к клиенту
6. Доставлено

## 9. Промокоды

### 9.1 Индивидуальные промокоды
- Назначение конкретному клиенту
- Причина выдачи
- Сумма или процент
- Срок действия

### 9.2 Глобальные акции
- Период действия
- Выбор точек
- Условия применения

## 10. Общие требования
- Логирование всех действий (audit log).
- Confirm modal для критических операций.
- Единый UI/UX стиль.
- Подготовка к масштабированию.
